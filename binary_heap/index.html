<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e93c6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: #f8f7f2;
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #1e93c6;
            margin-bottom: 30px;
            font-size: clamp(1.5rem, 4vw, 2.8rem);
            font-weight: 800;
            background: #1e93c6;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .heap-container {
            position: relative;
            overflow-x: auto;
            padding: 20px 0;
        }

        .heap-tree {
            position: relative;
            width: 100%;
            min-width: 700px;
            height: 500px;
            margin: 0 auto;
        }

        .node {
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #1e93c6;
            color: #f8f7f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 15px rgba(66, 153, 225, 0.4);
            z-index: 10;
        }

        .node:hover {
            transform: scale(1.15);
            box-shadow: 0 10px 30px #1e93c6;
        }

        .node.active {
            background: #ed8936;
            transform: scale(1.3);
            box-shadow: 0 12px 35px rgba(237, 137, 54, 0.7);
        }

        .node.parent {
            background: #38a169;
            transform: scale(1.2);
            box-shadow: 0 8px 25px rgba(56, 161, 105, 0.6);
        }

        .node.child {
            background: #9f7aea;
            transform: scale(1.2);
            box-shadow: 0 8px 25px rgba(159, 122, 234, 0.6);
        }

        .node.comparing {
            background: #f56565;
            animation: pulse 0.8s infinite;
        }

        .node.swapping {
            background: #e7a233;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1.1);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1.1);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0) scale(1.15);
            }

            50% {
                transform: translateY(-10px) scale(1.25);
            }
        }

        .edge {
            position: absolute;
            background: #1e93c6;
            border-radius: 3px;
            transform-origin: left center;
            z-index: 1;
            opacity: 0.7;
            transition: all 0.4s ease;
        }

        .edge.highlighted {
            background: #ed8936;
            opacity: 1;
            box-shadow: 0 3px 10px rgba(237, 137, 54, 0.5);
            height: 4px !important;
        }

        .array-container {
            margin: 30px 0;
            text-align: center;
        }

        .array-title {
            color: #1e93c6;
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .array-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            margin-bottom: 15px;
            padding: 0 15px;
        }

        .array-cell {
            width: 50px;
            height: 50px;
            border: 1px solid #f8f7f2;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            background: #1e93c6;
            color: #f8f7f2;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .array-cell:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.3);
            border-color: #1e93c6;
        }

        .array-cell.active {
            background: #ed8936;
            color: #f8f7f2;
            border-color: #ed8936;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(237, 137, 54, 0.5);
        }

        .array-cell.parent {
            background: #38a169;
            color: #f8f7f2;
            border-color: #38a169;
            transform: translateY(-2px) scale(1.05);
        }

        .array-cell.child {
            background: #9f7aea;
            color: #f8f7f2;
            border-color: #9f7aea;
            transform: translateY(-2px) scale(1.05);
        }

        .array-cell.comparing {
            background: #f56565;
            color: #f8f7f2;
            animation: pulse 0.8s infinite;
        }

        .array-cell.swapping {
            background: #e7a233;
            color: #f8f7f2;
            animation: bounce 0.6s ease-in-out;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-title {
            font-weight: 700;
            color: #1e93c6;
            font-size: 1.1rem;
            text-align: center;
        }

        .btn {
            background: #1e93c6;
            color: #f8f7f2;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px #1e93c6;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background: #1e93c6;
        }

        .btn.danger {
            background: #f56565;
        }

        .btn.secondary {
            color: #1e93c6;
            background: #f8f7f2
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 10px 12px;
            border: #f8f7f2;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #1e93c6;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .info-panel {
            background: #f8f7f2;
            border-radius: 16px;
            padding: 25px;
            margin-top: 25px;
            border-left: 5px solid #1e93c6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .info-title {
            font-weight: 700;
            color: #1e93c6;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .info-text {
            color: #333;
            line-height: 1.7;
            font-size: 15px;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: linear-gradient(135deg, #1e93c6 0%, #4299e1 100%);
            color: #f8f7f2;
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(30, 147, 198, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            font-size: 15px;
            min-width: 320px;
            max-width: 400px;
            word-wrap: break-word;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
            100% { transform: translateX(100%); }
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            box-shadow: 0 8px 32px rgba(56, 161, 105, 0.4);
        }

        .toast.warning {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            box-shadow: 0 8px 32px rgba(237, 137, 54, 0.4);
        }

        .toast.error {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
            box-shadow: 0 8px 32px rgba(229, 62, 62, 0.4);
        }

        .toast.info {
            background: linear-gradient(135deg, #3182ce 0%, #63b3ed 100%);
            box-shadow: 0 8px 32px rgba(49, 130, 206, 0.4);
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 16px 16px;
            transform-origin: left;
            animation: progressBar 5s linear forwards;
        }

        @keyframes progressBar {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        .toast-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 18px;
        }

        .heap-type-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .heap-type-btn {
            padding: 8px 16px;
            border: 2px solid #f8f7f2;
            background: #f8f7f2;
            color: #1e93c6;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .heap-type-btn.active {
            background: #1e93c6;
            color: #f8f7f2;
            border-color: #1e93c6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .heap-tree {
                min-width: 600px;
                height: 400px;
            }

            .node {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .array-cell {
                width: 45px;
                height: 45px;
                font-size: 14px;
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .heap-tree {
                min-width: 500px;
                height: 350px;
            }

            .node {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }

            .array-cell {
                width: 40px;
                height: 40px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸŒ³ ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«</h1>

        <div class="heap-type-selector">
            <div class="heap-type-btn active" onclick="setHeapType('max')">ğŸ“ˆ æœ€å¤§ãƒ’ãƒ¼ãƒ—</div>
            <div class="heap-type-btn" onclick="setHeapType('min')">ğŸ“‰ æœ€å°ãƒ’ãƒ¼ãƒ—</div>
        </div>

        <div class="main-content">
            <div class="heap-container">
                <div class="heap-tree" id="heapTree"></div>
            </div>

            <div class="array-container">
                <h2 class="array-title">ğŸ“Š é…åˆ—è¡¨ç¾</h2>
                <div class="array-display" id="arrayDisplay"></div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-title">ğŸš€ ã¯ã˜ã‚ã«</div>
                <button class="btn primary" onclick="createSampleHeap()">
                    ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ã‚’ä½œæˆ
                </button>
                <button class="btn" onclick="showEmptyDemo()">
                    ğŸ“– ç©ºã®ãƒ’ãƒ¼ãƒ—ã‹ã‚‰é–‹å§‹
                </button>
            </div>

            <div class="control-group">
                <div class="control-title">ğŸ” åŸºæœ¬æ“ä½œ</div>
                <button class="btn" onclick="animateTraversal()">
                    ğŸ”„ ãƒ¬ãƒ™ãƒ«é †èµ°æŸ»
                </button>
                <button class="btn secondary" onclick="resetAnimation()">
                    â†©ï¸ ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>

            <div class="control-group">
                <div class="control-title">â• è¦ç´ ã®è¿½åŠ </div>
                <div class="input-group">
                    <input type="number" id="addInput" class="input-field" placeholder="å€¤ã‚’å…¥åŠ›" min="0" max="99">
                    <button class="btn primary" onclick="addElement()">
                        â• Add
                    </button>
                </div>
                <button class="btn primary" onclick="addRandomElement()">
                    ğŸ² ãƒ©ãƒ³ãƒ€ãƒ è¿½åŠ 
                </button>
            </div>

            <div class="control-group">
                <div class="control-title">â– è¦ç´ ã®å‰Šé™¤</div>
                <button class="btn danger" onclick="popElement()">
                    ğŸ—‘ï¸ Pop (ãƒ«ãƒ¼ãƒˆå‰Šé™¤)
                </button>
                <button class="btn danger" onclick="clearHeap()">
                    ğŸ§¹ å…¨ã‚¯ãƒªã‚¢
                </button>
            </div>

            <div class="control-group">
                <div class="control-title">âš¡ ãƒ’ãƒ¼ãƒ—åŒ–</div>
                <button class="btn secondary" onclick="shuffleAndHeapify()">
                    ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ« â†’ Heapify
                </button>
                <button class="btn secondary" onclick="buildHeapFromArray()">
                    ğŸ—ï¸ é…åˆ—ã‹ã‚‰ãƒ’ãƒ¼ãƒ—æ§‹ç¯‰
                </button>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-title" id="infoTitle">ğŸ’¡ ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—ã«ã¤ã„ã¦</div>
            <div class="info-text" id="infoText">
                ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—ã¯å®Œå…¨äºŒåˆ†æœ¨æ§‹é€ ã§ã€è¦ªãƒãƒ¼ãƒ‰ãŒå­ãƒãƒ¼ãƒ‰ã‚ˆã‚Šå¤§ãã„ï¼ˆæœ€å¤§ãƒ’ãƒ¼ãƒ—ï¼‰ã¾ãŸã¯å°ã•ã„ï¼ˆæœ€å°ãƒ’ãƒ¼ãƒ—ï¼‰æ€§è³ªã‚’æŒã¡ã¾ã™ã€‚<br><br>
                ğŸ–±ï¸ <strong>ãƒ„ãƒªãƒ¼ã®ãƒãƒ¼ãƒ‰ã¾ãŸã¯é…åˆ—ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ï¼<br>
                âš¡ <strong>Add/Pop/Heapifyæ“ä½œ</strong>ã§ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å‹•ä½œã‚’å¯è¦–åŒ–ã§ãã¾ã™ï¼
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; color: #718096; font-size: 14px;">
            <small>
                Copyright Â© 2025 nuts3745 All rights reserved.
            </small>
        </footer>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let heapData = [];
        let heapType = 'max'; // 'max' or 'min'
        let currentlyActive = null;
        let isAnimating = false;
        let animationTimeout;

        function setHeapType(type) {
            if (isAnimating) return;

            heapType = type;
            document.querySelectorAll('.heap-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ãƒ’ãƒ¼ãƒ—ã‚’å†æ§‹ç¯‰
            buildHeap();
            renderHeap();
            updateInfo();
        }

        function compare(a, b) {
            return heapType === 'max' ? a > b : a < b;
        }

        function calculatePosition(index, treeWidth, treeHeight) {
            const level = Math.floor(Math.log2(index + 1));
            const maxLevel = Math.min(4, Math.floor(Math.log2(heapData.length)));
            const positionInLevel = index - (Math.pow(2, level) - 1);
            const nodesInLevel = Math.pow(2, level);

            const x = (treeWidth / (nodesInLevel + 1)) * (positionInLevel + 1) - 22.5;
            const y = (treeHeight / (maxLevel + 1)) * (level + 1) - 22.5;

            return { x, y };
        }

        function createEdge(parentPos, childPos) {
            const dx = childPos.x - parentPos.x;
            const dy = childPos.y - parentPos.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            const edge = document.createElement('div');
            edge.className = 'edge';
            edge.style.width = length + 'px';
            edge.style.height = '3px';
            edge.style.left = (parentPos.x + 22.5) + 'px';
            edge.style.top = (parentPos.y + 22.5) + 'px';
            edge.style.transform = `rotate(${angle}deg)`;

            return edge;
        }

        function renderHeap() {
            const container = document.getElementById('heapTree');
            container.innerHTML = '';

            if (heapData.length === 0) {
                // ç©ºã®ãƒ’ãƒ¼ãƒ—ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    color: #1e93c6;
                    font-size: 18px;
                    font-weight: 600;
                `;
                emptyMessage.innerHTML = `
                    ğŸŒ³ ç©ºã®ãƒ’ãƒ¼ãƒ—<br>
                    <span style="font-size: 14px; font-weight: 400;">è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>
                `;
                container.appendChild(emptyMessage);
                renderArray();
                return;
            }

            const treeWidth = container.offsetWidth;
            const treeHeight = container.offsetHeight;

            const positions = [];

            // ãƒãƒ¼ãƒ‰ã®ä½ç½®ã‚’è¨ˆç®—ã—ã¦ä¿å­˜
            for (let i = 0; i < heapData.length; i++) {
                positions[i] = calculatePosition(i, treeWidth, treeHeight);
            }

            // ã‚¨ãƒƒã‚¸ã‚’å…ˆã«æç”»
            for (let i = 1; i < heapData.length; i++) {
                const parentIndex = Math.floor((i - 1) / 2);
                const edge = createEdge(positions[parentIndex], positions[i]);
                edge.id = `edge-${parentIndex}-${i}`;
                container.appendChild(edge);
            }

            // ãƒãƒ¼ãƒ‰ã‚’æç”»
            for (let i = 0; i < heapData.length; i++) {
                const node = document.createElement('div');
                node.className = 'node';
                node.textContent = heapData[i];
                node.id = `node-${i}`;
                node.style.left = positions[i].x + 'px';
                node.style.top = positions[i].y + 'px';

                node.addEventListener('click', () => {
                    if (!isAnimating) highlightNode(i);
                });
                container.appendChild(node);
            }

            renderArray();
        }

        function renderArray() {
            const arrayDisplay = document.getElementById('arrayDisplay');
            arrayDisplay.innerHTML = '';

            if (heapData.length === 0) {
                // ç©ºã®é…åˆ—ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = `
                    color: #1e93c6;
                    font-size: 16px;
                    font-weight: 600;
                    padding: 20px;
                `;
                emptyMessage.textContent = 'ğŸ“Š ç©ºã®é…åˆ— - è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„';
                arrayDisplay.appendChild(emptyMessage);
                return;
            }

            for (let i = 0; i < heapData.length; i++) {
                const cell = document.createElement('div');
                cell.className = 'array-cell';
                cell.textContent = heapData[i];
                cell.id = `array-cell-${i}`;
                cell.addEventListener('click', () => {
                    if (!isAnimating) highlightNode(i);
                });
                arrayDisplay.appendChild(cell);
            }
        }

        function highlightNode(index) {
            clearAllHighlights();
            currentlyActive = index;

            // ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const treeNode = document.getElementById(`node-${index}`);
            if (treeNode) treeNode.classList.add('active');

            // é…åˆ—ã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const arrayCell = document.getElementById(`array-cell-${index}`);
            if (arrayCell) arrayCell.classList.add('active');

            // è¦ªå­é–¢ä¿‚ã‚‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const parentIndex = index > 0 ? Math.floor((index - 1) / 2) : null;
            const leftChild = 2 * index + 1;
            const rightChild = 2 * index + 2;

            if (parentIndex !== null) {
                const parentNode = document.getElementById(`node-${parentIndex}`);
                const parentCell = document.getElementById(`array-cell-${parentIndex}`);
                if (parentNode) parentNode.classList.add('parent');
                if (parentCell) parentCell.classList.add('parent');
            }

            if (leftChild < heapData.length) {
                const leftNode = document.getElementById(`node-${leftChild}`);
                const leftCell = document.getElementById(`array-cell-${leftChild}`);
                if (leftNode) leftNode.classList.add('child');
                if (leftCell) leftCell.classList.add('child');
            }

            if (rightChild < heapData.length) {
                const rightNode = document.getElementById(`node-${rightChild}`);
                const rightCell = document.getElementById(`array-cell-${rightChild}`);
                if (rightNode) rightNode.classList.add('child');
                if (rightCell) rightCell.classList.add('child');
            }

            updateDetailedInfo(index);
            highlightRelatedEdges(index);
        }

        function clearAllHighlights() {
            document.querySelectorAll('.node').forEach(node => {
                node.classList.remove('active', 'parent', 'child', 'comparing', 'swapping');
            });

            document.querySelectorAll('.array-cell').forEach(cell => {
                cell.classList.remove('active', 'parent', 'child', 'comparing', 'swapping');
            });

            document.querySelectorAll('.edge').forEach(edge => {
                edge.classList.remove('highlighted');
            });
        }

        function highlightRelatedEdges(index) {
            document.querySelectorAll('.edge').forEach(edge => {
                edge.classList.remove('highlighted');
            });

            if (index > 0) {
                const parentIndex = Math.floor((index - 1) / 2);
                const edge = document.getElementById(`edge-${parentIndex}-${index}`);
                if (edge) edge.classList.add('highlighted');
            }

            const leftChild = 2 * index + 1;
            const rightChild = 2 * index + 2;

            if (leftChild < heapData.length) {
                const leftEdge = document.getElementById(`edge-${index}-${leftChild}`);
                if (leftEdge) leftEdge.classList.add('highlighted');
            }

            if (rightChild < heapData.length) {
                const rightEdge = document.getElementById(`edge-${index}-${rightChild}`);
                if (rightEdge) rightEdge.classList.add('highlighted');
            }
        }

        function updateDetailedInfo(index) {
            const parentIndex = index > 0 ? Math.floor((index - 1) / 2) : null;
            const leftChild = 2 * index + 1;
            const rightChild = 2 * index + 2;

            document.getElementById('infoTitle').textContent = `ğŸ¯ ãƒãƒ¼ãƒ‰ ${heapData[index]} ã®è©³ç´°`;

            let infoText = `ğŸ¯ <strong>é¸æŠä¸­:</strong> ãƒãƒ¼ãƒ‰ ${heapData[index]} (é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${index})<br><br>`;

            if (parentIndex !== null) {
                infoText += `ğŸ‘† <strong>è¦ª:</strong> ${heapData[parentIndex]} (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${parentIndex})<br>`;
            } else {
                infoText += `ğŸ‘‘ <strong>ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰</strong> (è¦ªã¯ã‚ã‚Šã¾ã›ã‚“)<br>`;
            }

            if (leftChild < heapData.length || rightChild < heapData.length) {
                infoText += `ğŸ‘‡ <strong>å­:</strong> `;
                if (leftChild < heapData.length) {
                    infoText += `å·¦: ${heapData[leftChild]} (${leftChild}) `;
                }
                if (rightChild < heapData.length) {
                    infoText += `å³: ${heapData[rightChild]} (${rightChild})`;
                }
                infoText += `<br>`;
            } else {
                infoText += `ğŸƒ <strong>è‘‰ãƒãƒ¼ãƒ‰</strong> (å­ã¯ã‚ã‚Šã¾ã›ã‚“)<br>`;
            }

            infoText += `<br>ğŸ’¡ <strong>é…åˆ—ã§ã®ä½ç½®é–¢ä¿‚:</strong><br>`;
            infoText += `â€¢ è¦ªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: floor((${index}-1)/2) = ${parentIndex !== null ? parentIndex : 'ãªã—'}<br>`;
            infoText += `â€¢ å·¦ã®å­: 2Ã—${index}+1 = ${leftChild}${leftChild >= heapData.length ? ' (ç¯„å›²å¤–)' : ''}<br>`;
            infoText += `â€¢ å³ã®å­: 2Ã—${index}+2 = ${rightChild}${rightChild >= heapData.length ? ' (ç¯„å›²å¤–)' : ''}`;

            document.getElementById('infoText').innerHTML = infoText;
        }

        function updateInfo(title = 'ğŸ’¡ ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—ã«ã¤ã„ã¦', text = null) {
            document.getElementById('infoTitle').textContent = title;
            if (text) {
                document.getElementById('infoText').innerHTML = text;
            } else {
                if (heapData.length === 0) {
                    document.getElementById('infoText').innerHTML =
                        `ğŸš€ <strong>ãƒ’ãƒ¼ãƒ—å­¦ç¿’ãƒ„ãƒ¼ãƒ«ã¸ã‚ˆã†ã“ãï¼</strong><br><br>
                        ã¾ãšã¯ã€Œã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å®Œæˆã•ã‚ŒãŸãƒ’ãƒ¼ãƒ—ã®æ§‹é€ ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br><br>
                        ã¾ãŸã¯ã€Œç©ºã®ãƒ’ãƒ¼ãƒ—ã‹ã‚‰é–‹å§‹ã€ã§ã€ä¸€ã‹ã‚‰è¦ç´ ã‚’è¿½åŠ ã—ã¦ãƒ’ãƒ¼ãƒ—ã‚’æ§‹ç¯‰ã™ã‚‹éç¨‹ã‚’å­¦ç¿’ã§ãã¾ã™ã€‚<br><br>
                        ğŸ’¡ <strong>ãƒ’ãƒ¼ãƒ—ã¨ã¯ï¼Ÿ</strong><br>
                        â€¢ å®Œå…¨äºŒåˆ†æœ¨ã®æ§‹é€ <br>
                        â€¢ è¦ªãƒãƒ¼ãƒ‰ãŒå­ãƒãƒ¼ãƒ‰ã‚ˆã‚Š${heapType === 'max' ? 'å¤§ãã„' : 'å°ã•ã„'}ï¼ˆ${heapType === 'max' ? 'æœ€å¤§' : 'æœ€å°'}ãƒ’ãƒ¼ãƒ—ï¼‰<br>
                        â€¢ é…åˆ—ã§åŠ¹ç‡çš„ã«è¡¨ç¾å¯èƒ½`;
                } else {
                    document.getElementById('infoText').innerHTML =
                        `ãƒã‚¤ãƒŠãƒªãƒ’ãƒ¼ãƒ—ã¯å®Œå…¨äºŒåˆ†æœ¨æ§‹é€ ã§ã€è¦ªãƒãƒ¼ãƒ‰ãŒå­ãƒãƒ¼ãƒ‰ã‚ˆã‚Š${heapType === 'max' ? 'å¤§ãã„' : 'å°ã•ã„'}ï¼ˆ${heapType === 'max' ? 'æœ€å¤§' : 'æœ€å°'}ãƒ’ãƒ¼ãƒ—ï¼‰æ€§è³ªã‚’æŒã¡ã¾ã™ã€‚<br><br>
                        ğŸ–±ï¸ <strong>ãƒ„ãƒªãƒ¼ã®ãƒãƒ¼ãƒ‰ã¾ãŸã¯é…åˆ—ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ï¼<br>
                        âš¡ <strong>Add/Pop/Heapifyæ“ä½œ</strong>ã§ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å‹•ä½œã‚’å¯è¦–åŒ–ã§ãã¾ã™ï¼`;
                }
            }
        }

        // Toast Notification System
        let toastCounter = 0;
        let activeToasts = new Map();

        function showToast(message, type = 'info', duration = 5000, persistent = false) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast-${++toastCounter}`;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ
            let icon = '';
            switch(type) {
                case 'success': icon = 'âœ…'; break;
                case 'error': icon = 'âŒ'; break;
                case 'warning': icon = 'âš ï¸'; break;
                case 'info': icon = 'ğŸ”„'; break;
                default: icon = 'ğŸ“‹';
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                ${message}
                ${!persistent ? '<button class="toast-close" onclick="hideToast(\'' + toastId + '\')">&times;</button>' : ''}
                ${!persistent ? '<div class="toast-progress"></div>' : ''}
            `;
            
            toastContainer.appendChild(toast);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // æ°¸ç¶šçš„ã§ãªã„å ´åˆã¯è‡ªå‹•å‰Šé™¤
            if (!persistent) {
                setTimeout(() => {
                    hideToast(toastId);
                }, duration);
            }
            
            activeToasts.set(toastId, toast);
            return toastId;
        }

        function hideToast(toastId) {
            const toast = activeToasts.get(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                    activeToasts.delete(toastId);
                }, 400);
            }
        }

        function clearAllToasts() {
            activeToasts.forEach((toast, toastId) => {
                hideToast(toastId);
            });
        }

        function showStep(step, type = 'info', persistent = false) {
            return showToast(step, type, 3000, persistent);
        }

        function hideStep(toastId) {
            if (toastId) {
                hideToast(toastId);
            } else {
                // å…¨ã¦ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’éè¡¨ç¤º
                clearAllToasts();
            }
        }

        // ãƒ’ãƒ¼ãƒ—æ“ä½œé–¢æ•°
        function heapifyUp(index) {
            return new Promise(resolve => {
                if (index === 0) {
                    resolve();
                    return;
                }

                const parentIndex = Math.floor((index - 1) / 2);

                // æ¯”è¼ƒã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                highlightComparison([index, parentIndex]);

                setTimeout(() => {
                    if (compare(heapData[index], heapData[parentIndex])) {
                        // ã‚¹ãƒ¯ãƒƒãƒ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        highlightSwap([index, parentIndex]);

                        setTimeout(() => {
                            // å®Ÿéš›ã«ã‚¹ãƒ¯ãƒƒãƒ—
                            [heapData[index], heapData[parentIndex]] = [heapData[parentIndex], heapData[index]];
                            renderHeap();

                            setTimeout(() => {
                                heapifyUp(parentIndex).then(resolve);
                            }, 300);
                        }, 600);
                    } else {
                        clearAllHighlights();
                        resolve();
                    }
                }, 800);
            });
        }

        function heapifyDown(index) {
            return new Promise(resolve => {
                const leftChild = 2 * index + 1;
                const rightChild = 2 * index + 2;
                let targetIndex = index;

                const candidates = [index];
                if (leftChild < heapData.length) candidates.push(leftChild);
                if (rightChild < heapData.length) candidates.push(rightChild);

                // æ¯”è¼ƒå¯¾è±¡ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                highlightComparison(candidates);

                setTimeout(() => {
                    if (leftChild < heapData.length && compare(heapData[leftChild], heapData[targetIndex])) {
                        targetIndex = leftChild;
                    }

                    if (rightChild < heapData.length && compare(heapData[rightChild], heapData[targetIndex])) {
                        targetIndex = rightChild;
                    }

                    if (targetIndex !== index) {
                        // ã‚¹ãƒ¯ãƒƒãƒ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        highlightSwap([index, targetIndex]);

                        setTimeout(() => {
                            // å®Ÿéš›ã«ã‚¹ãƒ¯ãƒƒãƒ—
                            [heapData[index], heapData[targetIndex]] = [heapData[targetIndex], heapData[index]];
                            renderHeap();

                            setTimeout(() => {
                                heapifyDown(targetIndex).then(resolve);
                            }, 300);
                        }, 600);
                    } else {
                        clearAllHighlights();
                        resolve();
                    }
                }, 800);
            });
        }

        function highlightComparison(indices) {
            clearAllHighlights();
            indices.forEach(i => {
                const node = document.getElementById(`node-${i}`);
                const cell = document.getElementById(`array-cell-${i}`);
                if (node) node.classList.add('comparing');
                if (cell) cell.classList.add('comparing');
            });
        }

        function highlightSwap(indices) {
            clearAllHighlights();
            indices.forEach(i => {
                const node = document.getElementById(`node-${i}`);
                const cell = document.getElementById(`array-cell-${i}`);
                if (node) node.classList.add('swapping');
                if (cell) cell.classList.add('swapping');
            });
        }

        // æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ 
        async function createSampleHeap() {
            if (isAnimating) return;

            isAnimating = true;

            const toastId = showStep('ğŸš€ ã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info', true);
            updateInfo('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ã®ä½œæˆ', 'ãã‚Œã„ã«æ•´ç†ã•ã‚ŒãŸæœ€å¤§ãƒ’ãƒ¼ãƒ—ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚');

            // ãã‚Œã„ãªãƒ’ãƒ¼ãƒ—æ§‹é€ ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            const sampleData = [90, 80, 70, 60, 75, 65, 50, 40, 30, 55, 45, 35, 25];
            heapData = [...sampleData];

            renderHeap();

            await new Promise(resolve => setTimeout(resolve, 1000));

            hideToast(toastId);
            const successToastId = showStep('ã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ãŒå®Œæˆã—ã¾ã—ãŸï¼', 'success');
            updateInfo('ğŸ¯ ã‚µãƒ³ãƒ—ãƒ«ãƒ’ãƒ¼ãƒ—ã®èª¬æ˜',
                `ã“ã®ãƒ’ãƒ¼ãƒ—ã¯<strong>æœ€å¤§ãƒ’ãƒ¼ãƒ—</strong>ã®å®Œç’§ãªä¾‹ã§ã™ï¼š<br><br>
                ğŸ” <strong>ãƒ«ãƒ¼ãƒˆï¼ˆ90ï¼‰ãŒæœ€å¤§å€¤</strong><br>
                ğŸ‘† <strong>å„è¦ªãƒãƒ¼ãƒ‰ãŒå­ãƒãƒ¼ãƒ‰ã‚ˆã‚Šå¤§ãã„</strong><br>
                ğŸŒ³ <strong>å®Œå…¨äºŒåˆ†æœ¨ã®æ§‹é€ </strong><br>
                ğŸ“Š <strong>é…åˆ—ã§åŠ¹ç‡çš„ã«è¡¨ç¾</strong><br><br>
                ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦ªå­é–¢ä¿‚ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ï¼`);

            await new Promise(resolve => setTimeout(resolve, 3000));

            isAnimating = false;
        }

        async function showEmptyDemo() {
            if (isAnimating) return;

            isAnimating = true;

            const toastId = showStep('ğŸ“– ç©ºã®ãƒ’ãƒ¼ãƒ—ã‹ã‚‰å­¦ç¿’ã‚’é–‹å§‹', 'info');

            heapData = [];
            renderHeap();

            updateInfo('ğŸ“ ãƒ’ãƒ¼ãƒ—å­¦ç¿’ã‚¬ã‚¤ãƒ‰',
                `ç©ºã®ãƒ’ãƒ¼ãƒ—ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼<br><br>
                <strong>å­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—ï¼š</strong><br>
                1ï¸âƒ£ ã€Œâ• Addã€ã§è¦ç´ ã‚’ä¸€ã¤ãšã¤è¿½åŠ <br>
                2ï¸âƒ£ ãƒ’ãƒ¼ãƒ—ãŒè‡ªå‹•çš„ã«æ•´ç†ã•ã‚Œã‚‹æ§˜å­ã‚’è¦³å¯Ÿ<br>
                3ï¸âƒ£ ã€ŒğŸ—‘ï¸ Popã€ã§ãƒ«ãƒ¼ãƒˆè¦ç´ ã‚’å‰Šé™¤<br>
                4ï¸âƒ£ ã€ŒğŸ”€ Heapifyã€ã§é…åˆ—ã‹ã‚‰ãƒ’ãƒ¼ãƒ—ã‚’æ§‹ç¯‰<br><br>
                ğŸ’¡ <strong>ã¾ãšã¯æ•°å€¤ã‚’å…¥åŠ›ã—ã¦Addãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„ï¼</strong>`);

            await new Promise(resolve => setTimeout(resolve, 3000));

            isAnimating = false;
        }
        async function addElement() {
            if (isAnimating) return;

            const input = document.getElementById('addInput');
            const value = parseInt(input.value);

            if (isNaN(value) || value < 0 || value > 99) {
                showToast('0-99ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (heapData.length >= 31) {
                showToast('ãƒ’ãƒ¼ãƒ—ã®æœ€å¤§ã‚µã‚¤ã‚ºã«é”ã—ã¾ã—ãŸ', 'warning');
                return;
            }

            isAnimating = true;
            input.value = '';

            let toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— 1: å€¤ ${value} ã‚’é…åˆ—ã®æœ«å°¾ã«è¿½åŠ `, 'info', true);
            heapData.push(value);
            renderHeap();

            // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¦ç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const newIndex = heapData.length - 1;
            highlightNode(newIndex);

            await new Promise(resolve => setTimeout(resolve, 1000));

            hideToast(toastId);
            toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ’ãƒ¼ãƒ—æ€§è³ªã‚’ä¿ã¤ãŸã‚ã«ä¸Šå‘ãã«ãƒ’ãƒ¼ãƒ—åŒ–`, 'info', true);
            updateInfo('â• Addæ“ä½œã®å®Ÿè¡Œä¸­...', `æ–°ã—ã„è¦ç´  ${value} ã‚’ãƒ’ãƒ¼ãƒ—ã«è¿½åŠ ã—ã€è¦ªã¨ã®æ¯”è¼ƒã‚’é€šã˜ã¦ãƒ’ãƒ¼ãƒ—æ€§è³ªã‚’ç¶­æŒã—ã¾ã™ã€‚`);

            await heapifyUp(newIndex);

            hideToast(toastId);
            showStep('Addæ“ä½œå®Œäº†ï¼', 'success');
            await new Promise(resolve => setTimeout(resolve, 1000));

            updateInfo();
            isAnimating = false;
        }

        async function addRandomElement() {
            if (isAnimating) {
                showToast('æ“ä½œãŒå®Ÿè¡Œä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }

            const randomValue = Math.floor(Math.random() * 100);
            document.getElementById('addInput').value = randomValue;
            await addElement();
        }

        async function popElement() {
            if (isAnimating || heapData.length === 0) {
                if (heapData.length === 0) {
                    showToast('ãƒ’ãƒ¼ãƒ—ãŒç©ºã§ã™ã€‚è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'warning');
                }
                return;
            }

            isAnimating = true;
            const rootValue = heapData[0];

            let toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ«ãƒ¼ãƒˆè¦ç´  ${rootValue} ã‚’å–å¾—`, 'info', true);
            highlightNode(0);

            await new Promise(resolve => setTimeout(resolve, 1000));

            if (heapData.length === 1) {
                heapData.pop();
                renderHeap();
                hideToast(toastId);
                showStep('Popæ“ä½œå®Œäº†ï¼', 'success');
                await new Promise(resolve => setTimeout(resolve, 1000));
                updateInfo();
                isAnimating = false;
                return;
            }

            hideToast(toastId);
            toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— 2: æœ€å¾Œã®è¦ç´  ${heapData[heapData.length - 1]} ã‚’ãƒ«ãƒ¼ãƒˆã«ç§»å‹•`, 'info', true);

            // æœ€å¾Œã®è¦ç´ ã‚’ãƒ«ãƒ¼ãƒˆã«ç§»å‹•
            heapData[0] = heapData[heapData.length - 1];
            heapData.pop();
            renderHeap();
            highlightNode(0);

            await new Promise(resolve => setTimeout(resolve, 1000));

            hideToast(toastId);
            toastId = showStep('ã‚¹ãƒ†ãƒƒãƒ— 3: ä¸‹å‘ãã«ãƒ’ãƒ¼ãƒ—åŒ–ã—ã¦ãƒ’ãƒ¼ãƒ—æ€§è³ªã‚’å¾©å…ƒ', 'info', true);
            updateInfo('ğŸ—‘ï¸ Popæ“ä½œã®å®Ÿè¡Œä¸­...', `ãƒ«ãƒ¼ãƒˆè¦ç´ ã‚’å‰Šé™¤ã—ã€æœ€å¾Œã®è¦ç´ ã‚’ä¸Šã«ç§»å‹•ã—ã¦ãƒ’ãƒ¼ãƒ—æ€§è³ªã‚’å¾©å…ƒã—ã¾ã™ã€‚`);

            await heapifyDown(0);

            hideToast(toastId);
            showStep('Popæ“ä½œå®Œäº†ï¼', 'success');
            await new Promise(resolve => setTimeout(resolve, 1000));

            updateInfo();
            isAnimating = false;
        }

        async function shuffleAndHeapify() {
            if (isAnimating) {
                showToast('æ“ä½œãŒå®Ÿè¡Œä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }

            if (heapData.length === 0) {
                showToast('ãƒ’ãƒ¼ãƒ—ãŒç©ºã§ã™ã€‚è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }

            isAnimating = true;

            let toastId = showStep('ã‚¹ãƒ†ãƒƒãƒ— 1: é…åˆ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«', 'info', true);

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = heapData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [heapData[i], heapData[j]] = [heapData[j], heapData[i]];
            }

            renderHeap();
            await new Promise(resolve => setTimeout(resolve, 1000));

            hideToast(toastId);
            toastId = showStep('ã‚¹ãƒ†ãƒƒãƒ— 2: Bottom-upãƒ’ãƒ¼ãƒ—åŒ–ã‚’å®Ÿè¡Œ', 'info', true);
            updateInfo('ğŸ”€ Heapifyæ“ä½œã®å®Ÿè¡Œä¸­...', 'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸé…åˆ—ã‚’åŠ¹ç‡çš„ã«ãƒ’ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚æœ€å¾Œã®éè‘‰ãƒãƒ¼ãƒ‰ã‹ã‚‰é–‹å§‹ã—ã¦é€†é †ã«å‡¦ç†ã—ã¾ã™ã€‚');

            // Bottom-up heapify
            const lastNonLeaf = Math.floor(heapData.length / 2 - 1);

            for (let i = lastNonLeaf; i >= 0; i--) {
                hideToast(toastId);
                toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— ${lastNonLeaf - i + 3}: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${i} ã‹ã‚‰ãƒ’ãƒ¼ãƒ—åŒ–`, 'info', true);
                await heapifyDown(i);
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            hideToast(toastId);
            showStep('Heapifyæ“ä½œå®Œäº†ï¼', 'success');
            await new Promise(resolve => setTimeout(resolve, 1500));

            updateInfo();
            isAnimating = false;
        }

        async function buildHeapFromArray() {
            if (isAnimating) {
                showToast('æ“ä½œãŒå®Ÿè¡Œä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }

            isAnimating = true;

            // æ–°ã—ã„ãƒ©ãƒ³ãƒ€ãƒ é…åˆ—ã‚’ç”Ÿæˆ
            const newArray = [];
            const size = 8 + Math.floor(Math.random() * 8); // 8-15è¦ç´ 

            for (let i = 0; i < size; i++) {
                newArray.push(Math.floor(Math.random() * 100));
            }

            let toastId = showStep(`ã‚¹ãƒ†ãƒƒãƒ— 1: æ–°ã—ã„é…åˆ— [${newArray.join(', ')}] ã‚’ç”Ÿæˆ`, 'info', true);

            heapData = [...newArray];
            renderHeap();

            await new Promise(resolve => setTimeout(resolve, 1500));

            hideToast(toastId);
            toastId = showStep('ã‚¹ãƒ†ãƒƒãƒ— 2: é…åˆ—ã‹ã‚‰ãƒ’ãƒ¼ãƒ—ã‚’æ§‹ç¯‰', 'info', true);
            updateInfo('ğŸ—ï¸ ãƒ’ãƒ¼ãƒ—æ§‹ç¯‰ä¸­...', 'ä»»æ„ã®é…åˆ—ã‹ã‚‰åŠ¹ç‡çš„ã«ãƒ’ãƒ¼ãƒ—ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚Bottom-upã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ O(n) æ™‚é–“ã§å®Œäº†ã—ã¾ã™ã€‚');

            await buildHeap();

            hideToast(toastId);
            showStep('ãƒ’ãƒ¼ãƒ—æ§‹ç¯‰å®Œäº†ï¼', 'success');
            await new Promise(resolve => setTimeout(resolve, 1500));

            updateInfo();
            isAnimating = false;
        }

        async function buildHeap() {
            const lastNonLeaf = Math.floor(heapData.length / 2 - 1);

            for (let i = lastNonLeaf; i >= 0; i--) {
                await heapifyDown(i);
                await new Promise(resolve => setTimeout(resolve, 400));
            }
        }

        function clearHeap() {
            if (isAnimating) {
                showToast('æ“ä½œãŒå®Ÿè¡Œä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }

            if (heapData.length === 0) {
                showToast('ãƒ’ãƒ¼ãƒ—ã¯æ—¢ã«ç©ºã§ã™ã€‚', 'info');
                return;
            }

            heapData = [];
            renderHeap();
            updateInfo('ğŸ§¹ ãƒ’ãƒ¼ãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'ãƒ’ãƒ¼ãƒ—ãŒç©ºã«ãªã‚Šã¾ã—ãŸã€‚æ–°ã—ã„è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
            showToast('ãƒ’ãƒ¼ãƒ—ã‚’æ­£å¸¸ã«ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        async function animateTraversal() {
            if (isAnimating) {
                showToast('æ“ä½œãŒå®Ÿè¡Œä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            if (heapData.length === 0) {
                showToast('ãƒ’ãƒ¼ãƒ—ãŒç©ºã§ã™ã€‚è¦ç´ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }

            isAnimating = true;
            const toastId = showStep('ãƒ¬ãƒ™ãƒ«é †èµ°æŸ»ã‚’å®Ÿè¡Œä¸­...', 'info', true);
            updateInfo('ğŸ”„ ãƒ¬ãƒ™ãƒ«é †èµ°æŸ»', 'ãƒ’ãƒ¼ãƒ—ã‚’ãƒ¬ãƒ™ãƒ«é †ï¼ˆå¹…å„ªå…ˆï¼‰ã§å·¡å›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †ã¨åŒã˜ã§ã™ã€‚');

            for (let i = 0; i < heapData.length; i++) {
                clearAllHighlights();
                highlightNode(i);
                await new Promise(resolve => setTimeout(resolve, 600));
            }

            hideToast(toastId);
            showToast('ãƒ¬ãƒ™ãƒ«é †èµ°æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            updateInfo();
            isAnimating = false;
        }

        function resetAnimation() {
            if (animationTimeout) {
                clearTimeout(animationTimeout);
            }

            clearAllHighlights();
            clearAllToasts();
            currentlyActive = null;
            isAnimating = false;
            updateInfo();
            showToast('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info', 2000);
        }

        // åˆæœŸåŒ–
        function initialize() {
            renderHeap();
            updateInfo();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('addInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addElement();
            }
        });

        window.addEventListener('load', initialize);
    </script>
</body>

</html>